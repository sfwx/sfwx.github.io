<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="./pack_icon.png">
    <title>
      FwX â€¢ FloralCapes
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <img src="./pack_icon.png" width="256px" style="image-rendering: pixelated;">
    <canvas id="skin" width="64px" height="64px" hidden></canvas>
    <form id="uploadForm">
      <div>
        <label for="skinUpload">Upload Skin:</label>
        <input type="file" id="skinUpload" name="skinUpload" accept=".png">
      </div>
      <div>
        <label for="capeUpload">Upload Cape:</label>
        <input type="file" id="capeUpload" name="capeUpload" accept=".png">
      </div>
      <button type="button" onclick="handleUpload()">Upload</button>
    </form>

    <script>
      async function loadImage(src) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = src;
        });
      }

      async function createSkin(size, skinFile, capeFile) {
        if (size === 64) {
          const skinImg = document.getElementById("skin").getContext("2d");
          skinImg.clearRect(0, 0, document.getElementById("skin").width, document.getElementById("skin").height);
          const skin = await loadImage(URL.createObjectURL(skinFile));
          const cape = await loadImage(URL.createObjectURL(capeFile));
          const sign = await loadImage("./64/signature.png");
          skinImg.drawImage(skin, 0, 0);
          skinImg.drawImage(sign, 0, 0, 64, 64, 0, 0, 64, 64);
          skinImg.drawImage(cape, 1, 1, 5, 16, 56, 16, 5, 16);
          skinImg.drawImage(cape, 6, 1, 5, 16, 56, 32, 5, 16);
          document.querySelector("img").src = skinImg.canvas.toDataURL();
          document.querySelector("img").alt = skinFile.name;
        }
      }

      function skinDownload() {
        const skin = document.getElementById("skin");
        const name = document.querySelector("img").alt;
        const link = document.createElement("a");
        link.download = name;
        link.href = skin.toDataURL();
        link.click();
        link.remove();
      }

      function handleUpload() {
        const skinFile = document.getElementById("skinUpload").files[0];
        const capeFile = document.getElementById("capeUpload").files[0];
        document.querySelector("img").alt = skinFile.name;
        if (skinFile && capeFile) {
          createSkin(64, skinFile, capeFile);
        } else {
          alert("Por favor, selecione ambos os arquivos de skin e cape.");
        }
      }

      document.querySelector("img").addEventListener("click", skinDownload);
    </script>
  </body>
</html>
